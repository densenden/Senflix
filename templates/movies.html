{% extends "base.html" %}
{% from "components/movie_card.html" import movie_card %}
{% from 'components/navigation.html' import top_nav, side_nav %}

{% block title %}Movies - SenFlix{% endblock %}

{% block content %}
{# Removed debug script #}

{# Define anchors for sidebar navigation #}
{% set anchors = [
    {'id': 'new-releases', 'label': 'New Releases'},
    {'id': 'popular', 'label': 'Popular'},
    {'id': 'friends-favorites', 'label': "Friends' Favorites"},
    {'id': 'top-rated', 'label': 'Top Rated by Community'},
    {'id': 'recent-comments', 'label': 'Recent Comments'}
] %}

{{ top_nav(current_user=current_user) }}

<div class="flex flex-row bg-black min-h-screen pt-16 snap-container" style="overflow-y: auto;">
  {{ side_nav(anchors=anchors, categories=categories) }}
  
  <main id="main-content" class="flex-1 bg-black text-gray-100 transition-all duration-500 ease-in-out" style="margin-left: 16rem;">
    <div class="space-y-12 px-4 md:px-10">
      
      {# --- Hero Section --- #}
      <section class="relative h-[48vh] min-h-[320px] flex items-end snap-section" id="hero">
        <div class="absolute inset-0">
          <img src="{{ url_for('static', filename='hero.png') }}" alt="Hero background" class="w-full h-full object-cover opacity-40">
          <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent"></div>
        </div>
        <div class="relative z-10 p-8">
          <h1 class="text-4xl md:text-5xl font-bold mb-2">Welcome back, {{ current_user.name if current_user.is_authenticated else 'Guest' }}!</h1>
          <p class="text-lg text-gray-300">Discover new movies and keep track of your favorites.</p>
        </div>
      </section>

      {# --- New Releases Section --- #}
      <section id="new-releases" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">New Releases</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in new_releases %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>

      {# --- Popular Section --- #}
      <section id="popular" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Popular</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in popular_movies %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>

      {# --- Friends' Favorites Section (Currently Disabled) --- #}
      <section id="friends-favorites" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Friends' Favorites</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in friends_favorites %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No friend favorites found (feature disabled).</p>
          {% endfor %}
        </div>
      </section>

      {# --- Top Rated Section --- #}
      <section id="top-rated" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Top Rated by Community</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in top_rated %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>

      {# --- Recent Comments Section --- #}
      <section id="recent-comments" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Recent Comments</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          {% for entry in recent_comments %}
            {# --- Simplified Comment Card --- #}
            {% set movie = entry.get('movie', {}) %}
            {% set movie_id = movie.get('id') %}
            {% set movie_name = movie.get('name', 'Movie') %}
            {% set movie_year = movie.get('year') %}
            {% set poster_img = movie.get('omdb_data', {}).get('poster_img') %}
            {% set comment_text = entry.get('comment_text', '...') %}
            {% set user_name = entry.get('comment_user_name', 'User') %}
            {% set avatar_url = entry.get('comment_user_avatar_url') %}

            {# Outer container with link and basic styling #}
            <a href="{{ url_for('movie_detail', movie_id=movie_id) if movie_id else '#' }}" 
               class="group relative block h-32 rounded-xl overflow-hidden shadow-lg bg-gray-800 hover:shadow-xl transition-shadow duration-300">
                
                {# Background Image: Contained, left-aligned #}
                <div class="absolute inset-0 w-1/3 bg-no-repeat bg-contain bg-left-center opacity-50 group-hover:opacity-75 transition-opacity duration-300" 
                     style="{% if poster_img %}background-image: url('{{ url_for('static', filename='movies/' ~ poster_img) }}');{% endif %}">
                </div>
                
                {# Gradient Overlay #}
                <div class="absolute inset-0 bg-gradient-to-r from-gray-800/95 via-gray-800/80 to-transparent">
                </div>
                
                {# Text Content Area - Padding left to avoid background #}
                <div class="relative flex flex-col justify-center h-full p-4 pl-[30%] text-gray-100"> {# Adjust pl if needed based on w-1/3 #}
                    {# Movie Name & Year (Small) #}
                    <div class="mb-1">
                        <h4 class="text-xs font-semibold text-gray-300 truncate" title="{{ movie_name }}">{{ movie_name }}</h4>
                        <p class="text-xs text-gray-400">{{ movie_year }}</p>
                    </div>
                    {# Comment Text (Large, Clamped) #}
                    <p class="text-lg text-gray-100 font-medium line-clamp-2 leading-snug">
                        {{ comment_text }}
                    </p>
                </div>
                
                {# Hover Content: Avatar and User Name #}
                <div class="absolute bottom-2 left-2 flex items-center space-x-2 p-1 rounded-full bg-black/40 
                            opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    {% if avatar_url %}
                    <img src="{{ url_for('static', filename=avatar_url) }}" alt="{{ user_name }}" class="w-5 h-5 rounded-full object-cover border border-gray-500">
                    {% endif %}
                    <span class="text-xs text-white font-medium">{{ user_name }}</span>
                </div>
            </a>
          {% else %}
            <p>No recent comments.</p>
          {% endfor %}
        </div>
      </section>

      {# --- Category Sections --- #}
      {% for category in categories %}
      <section id="category-{{ category['id'] }}" class="snap-section min-h-screen relative" style="height: 100vh;">
        {# Background Image #}
        <div class="absolute inset-0 z-0">
          <img src="{{ url_for('static', filename='categories/' + (category['img'] or 'default-category.jpg')) }}"
               alt="{{ category['name'] }}"
               class="w-full h-full object-cover opacity-30"
               onerror="this.src='/static/categories/default-category.jpg';"> {# Fallback via onerror #}
          <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-black/60"></div> {# Gradient overlay #}
        </div>
        {# Content #}
        <div class="relative z-10 h-full px-4 md:px-10 py-8 flex flex-col">
          <h2 class="text-3xl font-bold mb-6 text-gray-100">{{ category['name'] }}</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 flex-grow overflow-y-auto pb-8">
            {# Efficiently display movies for this category using data passed from backend #}
            {% set category_movies = category.get('movies', []) %}
            {% if category_movies %}
              {% for movie in category_movies %}
                {{ movie_card(movie) }}
              {% endfor %}
            {% else %}
              <p>No movies found in this category.</p>
            {% endif %}
          </div>
        </div>
      </section>
      {% endfor %}
    </div>
  </main>
</div>

{# Basic Styling #}
<style>
  body { background: #000; }
  .sidebar-link { color: #e5e7eb; text-decoration: none; transition: color 0.2s; }
  .sidebar-link:hover { color: #ef4444; }
  .sidebar-link.active { color: #ef4444; font-weight: bold; }
  .sidebar-hidden { margin-left: 0 !important; }
  #sidebar { position: fixed; top: 4rem; left: 0; height: calc(100vh - 4rem); z-index: 40; }
  .snap-container { scroll-snap-type: y mandatory; }
  .snap-section { scroll-snap-align: start; min-height: 50vh; }
  
  /* Basic styles for comment card - can be refined */
  .comment-card-3d {
    /* Remove 3D specific styles if no longer used */
    /* background-color: #1f2937; */ /* Fallback bg if no poster */
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;  
    overflow: hidden;
  }
</style>

{# --- Rating Modal --- #}
<div id="ratingModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-[9999]">
  <div class="bg-gray-900 p-6 rounded-lg max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-6">Rate Movie</h2>
    
    <form id="ratingForm" class="space-y-6">
      <input type="hidden" id="modalMovieId" name="movie_id"> {# Renamed ID #}
      
      {# Star Rating Input #}
      <div>
        <label class="block text-sm font-medium mb-2">Your Rating (1-5 Stars)</label> {# Clarified range #}
        <div class="flex items-center space-x-1" id="starRatingContainer">
          {# Stars 1-5 (0.5 increments internally handled) #}
          {% for i in range(1, 6) %}
          <button type="button" 
                  class="rating-star w-8 h-8 text-gray-500 hover:text-yellow-400 transition-colors duration-150" 
                  data-value="{{ i }}">
            <svg fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
          </button>
          {% endfor %}
        </div>
        <input type="hidden" id="ratingValue" name="rating" value="0"> {# Hidden input to store precise rating #}
      </div>
      
      {# Comment Textarea #}
      <div>
        <label for="comment" class="block text-sm font-medium mb-2">Your Comment (Optional)</label>
        <textarea id="comment" name="comment" rows="3"
                  class="w-full px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:border-red-500 focus:ring-1 focus:ring-red-500 text-white"></textarea>
      </div>
      
      {# Modal Buttons #}
      <div class="flex justify-end space-x-4">
        <button type="button" onclick="hideRatingModal()" 
                class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors">
          Cancel
        </button>
        <button type="submit" 
                class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white transition-colors">
          Submit Rating
        </button>
      </div>
    </form>
  </div>
</div>

{# --- JavaScript --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Removed image fallback logic

    // --- Rating Modal Logic ---
    let selectedRating = 0;
    const ratingContainer = document.getElementById('starRatingContainer');
    const ratingInput = document.getElementById('ratingValue');
    const stars = ratingContainer.querySelectorAll('.rating-star');

    window.showRatingModal = function(movieId) {
        document.getElementById('modalMovieId').value = movieId;
        // TODO: Fetch existing rating/comment for this movie/user if available
        // resetRatingForm(); // Reset form when showing
        document.getElementById('ratingModal').classList.remove('hidden');
        document.getElementById('ratingModal').classList.add('flex');
    }

    window.hideRatingModal = function() {
        document.getElementById('ratingModal').classList.add('hidden');
        document.getElementById('ratingModal').classList.remove('flex');
    }

    function updateStarsVisual(rating) {
        stars.forEach(star => {
            star.classList.toggle('text-yellow-400', parseFloat(star.dataset.value) <= rating);
            star.classList.toggle('text-gray-500', parseFloat(star.dataset.value) > rating);
        });
    }

    stars.forEach(star => {
        star.addEventListener('click', () => {
            selectedRating = parseFloat(star.dataset.value);
            ratingInput.value = selectedRating; // Update hidden input
            updateStarsVisual(selectedRating);
        });
         // Optional: Add mouseover effect for potential rating
        // star.addEventListener('mouseover', () => updateStarsVisual(parseFloat(star.dataset.value)));
        // star.addEventListener('mouseleave', () => updateStarsVisual(selectedRating)); 
    });

    document.getElementById('ratingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        // Rating is now directly from the hidden input
        // formData.append('rating', selectedRating); 
        
        // Simple validation
        if (parseFloat(formData.get('rating')) <= 0) {
            alert('Please select a rating.');
            return;
        }

        try {
            const response = await fetch('/rate_movie', {
                method: 'POST',
                body: new URLSearchParams(formData) // Send as form data
            });
            const result = await response.json();

            if (response.ok && result.success) {
                hideRatingModal();
                // Maybe show a success message instead of reloading?
                // alert('Rating submitted!'); 
                location.reload(); // Or update UI dynamically
            } else {
                throw new Error(result.error || 'Failed to submit rating');
            }
        } catch (error) {
            console.error('Rating submission error:', error);
            alert('Error submitting rating: ' + error.message);
        }
    });

    // --- Movie Card & Comment Card 3D Hover Effect ---
    function initialize3DHoverEffect(selector) {
        const cardWrappers = document.querySelectorAll(selector);
        cardWrappers.forEach(wrapper => {
            // Prevent attaching multiple listeners
            if (wrapper.dataset.interactiveAttached === 'true') return;
            wrapper.dataset.interactiveAttached = 'true';

            // Only apply to movie cards now
            const card = wrapper.querySelector('.movie-card-3d'); 
            if (!card) return;

            const tiltIntensity = 10; // Adjust tilt intensity

            wrapper.addEventListener('mousemove', (e) => {
                const rect = wrapper.getBoundingClientRect();
                // Calculate position relative to the card center
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                // Calculate rotation angles
                const rotateY = (x / (rect.width / 2)) * tiltIntensity;
                const rotateX = (y / (rect.height / 2)) * -tiltIntensity;
                // Apply the transform
                card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.03)`;
            });

            wrapper.addEventListener('mouseleave', () => {
                card.style.transform = 'rotateX(0deg) rotateY(0deg) scale(1)'; // Reset transform
            });
        });
    }
    initialize3DHoverEffect('.movie-card-3d-wrapper'); // Initialize ONLY for movie cards
    // initialize3DHoverEffect('.comment-card-3d-wrapper'); // Removed for comments

    // --- Movie Card Action Button Handlers ---
    async function handleMovieAction(buttonElement, actionType) {
        const movieId = buttonElement.dataset.movieId;
        if (!movieId) {
            console.error('Movie ID not found on button');
            return;
        }
        
        const endpoint = actionType === 'watchlist' ? `/toggle_watchlist/${movieId}` : `/toggle_watched/${movieId}`;
        const wasActive = buttonElement.classList.contains('action-icon-active');
        const titleAdd = actionType === 'watchlist' ? 'Add to Watchlist' : 'Mark as Watched';
        const titleRemove = actionType === 'watchlist' ? 'Remove from Watchlist' : 'Mark as Unwatched';

        // Optimistic UI update
        buttonElement.classList.toggle('action-icon-active');
        buttonElement.title = wasActive ? titleAdd : titleRemove;

        try {
            const response = await fetch(endpoint, { method: 'POST' });
            const result = await response.json();
            if (!response.ok || result.error) {
                throw new Error(result.error || 'Server error');
            }
            console.log(`${actionType} toggle successful for movie ${movieId}`);
            // Update other UI elements if needed (e.g., watched avatars)
            // Maybe trigger a custom event to refresh avatar section?
        } catch (error) {
            console.error(`Failed to toggle ${actionType}:`, error);
            // Revert UI on error
            buttonElement.classList.toggle('action-icon-active', wasActive); // Set back to original state
            buttonElement.title = wasActive ? titleRemove : titleAdd;
            // alert(`Could not update ${actionType}: ` + error.message);
        }
    }

    // Event delegation for action buttons
    document.getElementById('main-content').addEventListener('click', function(event) {
        const watchlistButton = event.target.closest('.watchlist-toggle-btn');
        const watchedButton = event.target.closest('.watched-toggle-btn');
        const rateButton = event.target.closest('.rate-btn');

        if (watchlistButton) {
            handleMovieAction(watchlistButton, 'watchlist');
        } else if (watchedButton) {
            handleMovieAction(watchedButton, 'watched');
        } else if (rateButton) {
            const movieId = rateButton.dataset.movieId;
            if (movieId) {
                window.showRatingModal(movieId);
            } else {
                console.error('Movie ID missing on rate button');
            }
        }
    });

    // --- General UI & Navigation Logic ---
    
    // Filter logic (placeholder)
    const categoryFilter = document.getElementById('category-filter');
    const platformFilter = document.getElementById('platform-filter');
    function applyFilters() {
        const categoryId = categoryFilter ? categoryFilter.value : null;
        const platformId = platformFilter ? platformFilter.value : null;
        console.log('Filtering - Category:', categoryId, 'Platform:', platformId);
        // Add actual filtering logic here (e.g., redirect or AJAX fetch)
    }
    if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
    if (platformFilter) platformFilter.addEventListener('change', applyFilters);

    // Scrollspy for sidebar
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const sections = document.querySelectorAll('.snap-section');
    const mainContent = document.getElementById('main-content');
    
    function setActiveLink() {
        if (!mainContent) return;
        let currentSectionId = null;
        const scrollPosition = mainContent.scrollTop + (window.innerHeight * 0.3); // Offset for better detection

        sections.forEach(section => {
            if (section.offsetTop <= scrollPosition && 
                section.offsetTop + section.offsetHeight > scrollPosition) {
                currentSectionId = section.getAttribute('id');
            }
        });

        sidebarLinks.forEach(link => {
            link.classList.remove('active');
            const href = link.getAttribute('href');
            if (href && href === `#${currentSectionId}`) {
                link.classList.add('active');
            }
        });
        
        // Default to first if none found (e.g., at top)
        if (!currentSectionId && sidebarLinks.length > 0) {
             const firstVisibleSection = sections[0] ? sections[0].id : null;
             if(firstVisibleSection){
                 const firstLink = document.querySelector(`.sidebar-link[href="#${firstVisibleSection}"]`);
                 if(firstLink) firstLink.classList.add('active');
             }
        }
    }
    
    // Use main content scroll event if sidebar is fixed
    if (mainContent) {
        mainContent.addEventListener('scroll', setActiveLink);
    }
    // Set initial active link on load
    setActiveLink(); 
});
</script>
{% endblock %}