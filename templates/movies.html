{% extends "base.html" %}
{% from "components/movie_card.html" import movie_card %}
{% from 'components/navigation.html' import top_nav, side_nav %}

{% block title %}Movies - SenFlix{% endblock %}

{% block content %}
{% set anchors = [
    {'id': 'new-releases', 'label': 'New Releases'},
    {'id': 'popular', 'label': 'Popular'},
    {'id': 'friends-favorites', 'label': "Friends' Favorites"},
    {'id': 'top-rated', 'label': 'Top Rated by Community'},
    {'id': 'recent-comments', 'label': 'Recent Comments'}
] %}
{{ top_nav(current_user=current_user) }}
<div class="flex flex-row bg-black min-h-screen pt-16 snap-container" style="overflow-y: auto;">
  {{ side_nav(anchors=anchors, categories=categories) }}
  <main id="main-content" class="flex-1 bg-black text-gray-100 transition-all duration-500 ease-in-out" style="margin-left: 16rem;">
    <div class="space-y-12 px-4 md:px-10">
      <!-- Hero Section -->
      <section class="relative h-[48vh] min-h-[320px] flex items-end snap-section" id="hero">
        <div class="absolute inset-0">
          <img src="{{ url_for('static', filename='hero.png') }}" alt="Hero background" class="w-full h-full object-cover opacity-40">
          <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent"></div>
        </div>
        <div class="relative z-10 p-8">
          <h1 class="text-4xl md:text-5xl font-bold mb-2">Welcome back, {{ current_user.name if current_user.is_authenticated else 'Guest' }}!</h1>
          <p class="text-lg text-gray-300">Discover new movies and keep track of your favorites.</p>
        </div>
      </section>

      <!-- New Releases Section -->
      <section id="new-releases" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">New Releases</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in new_releases %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>

      <!-- Popular Section -->
      <section id="popular" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Popular</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in popular_movies %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>

      <!-- Friends' Favorites Section -->
      <section id="friends-favorites" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Friends' Favorites</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in friends_favorites %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>

      <!-- Top Rated Section -->
      <section id="top-rated" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Top Rated by Community</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in top_rated %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>

      <!-- Recent Comments Section -->
      <section id="recent-comments" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Recent Comments</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for movie in recent_comments %}
            <div class="bg-gray-900/90 rounded-xl p-4 shadow-lg">
              <div class="flex items-center gap-4">
                {% if movie.omdb_data and movie.omdb_data.effective_poster %}
                  {% if movie.omdb_data.poster_img %}
                    <img src="{{ url_for('static', filename='movies/' + movie.omdb_data.poster_img) }}" 
                         alt="{{ movie.name }}" 
                         class="w-16 h-24 object-cover rounded-md">
                  {% else %}
                    <img src="{{ movie.omdb_data.poster_url }}" 
                         alt="{{ movie.name }}" 
                         class="w-16 h-24 object-cover rounded-md">
                  {% endif %}
                {% else %}
                  <div class="w-16 h-24 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center rounded-md">
                    <span class="text-gray-300 text-xs">{{ movie.name[:10] }}{% if movie.name|length > 10 %}...{% endif %}</span>
                  </div>
                {% endif %}
                <div>
                  <h3 class="font-bold">{{ movie.name }}</h3>
                  <p class="text-sm text-gray-400">{{ movie.year }}</p>
                </div>
              </div>
              {% if movie.favorites %}
                {% for favorite in movie.favorites[:1] %}
                  {% if favorite.comment %}
                    <p class="mt-3 text-sm italic">"{{ favorite.comment }}"</p>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
          {% else %}
            <p>No recent comments.</p>
          {% endfor %}
        </div>
      </section>

      <!-- Category Sections -->
      {% for category in categories %}
      <section id="category-{{ category['id'] }}" class="snap-section min-h-screen relative" style="height: 100vh;">
        <div class="absolute inset-0 z-0">
          <img src="{{ url_for('static', filename='categories/' + category['img']) }}"
               alt="{{ category['name'] }}"
               class="w-full h-full object-cover opacity-30"
               onerror="this.src='/static/categories/default-category.jpg';">
          <div class="absolute inset-0 bg-gradient-to-t from-black via-black/80 to-black/60"></div>
        </div>
        <div class="relative z-10 h-full px-4 md:px-10 py-8 flex flex-col">
          <h2 class="text-3xl font-bold mb-6 text-gray-100">{{ category['name'] }}</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 flex-grow overflow-y-auto pb-8">
            {# Direkte Filterung ohne {% do %} #}
            {% set found = false %}
            {% if category.get('movies') %}
              {% for movie in category['movies'][:10] %}
                {% set found = true %}
                {{ movie_card(movie) }}
              {% endfor %}
            {% else %}
              {% for movie in movies %}
                {% if movie.get('categories') %}
                  {% set in_category = false %}
                  {% for cat in movie['categories'] %}
                    {% if cat['id'] == category['id'] %}
                      {% set in_category = true %}
                    {% endif %}
                  {% endfor %}
                  {% if in_category %}
                    {% set found = true %}
                    {{ movie_card(movie) }}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
            
            {% if not found %}
              <p>No movies found in this category.</p>
            {% endif %}
          </div>
        </div>
      </section>
      {% endfor %}
    </div>
  </main>
</div>
<style>
  body { background: #000; }
  .sidebar-link { color: #e5e7eb; text-decoration: none; transition: color 0.2s; }
  .sidebar-link:hover { color: #ef4444; }
  .sidebar-link.active { color: #ef4444; font-weight: bold; }
  .sidebar-hidden {
    margin-left: 0 !important; /* Ensure margin is removed */
    /* max-width: 100vw !important; Might not be needed if flex-1 works correctly */
  }
  #sidebar {
    position: fixed;
    top: 4rem;
    left: 0;
    height: calc(100vh - 4rem);
    z-index: 40;
  }
  .snap-container { scroll-snap-type: y mandatory; }
  .snap-section { scroll-snap-align: start; min-height: 50vh; }
</style>

<!-- Rating Modal -->
<div id="ratingModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center">
  <div class="bg-gray-900 p-6 rounded-lg max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-6">Rate Movie</h2>
    
    <form id="ratingForm" class="space-y-6">
      <input type="hidden" id="movieId" name="movie_id">
      
      <!-- Star Rating -->
      <div>
        <label class="block text-sm font-medium mb-2">Your Rating</label>
        <div class="flex items-center space-x-1">
          {% for i in range(1, 11) %}
          <button type="button" 
                  class="rating-star w-8 h-8 text-gray-400 hover:text-yellow-400"
                  data-rating="{{ i }}">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
          </button>
          {% endfor %}
        </div>
      </div>
      
      <!-- Comment -->
      <div>
        <label for="comment" class="block text-sm font-medium mb-2">Your Comment (Optional)</label>
        <textarea id="comment" name="comment" rows="3"
                  class="w-full px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:border-red-500 focus:ring-1 focus:ring-red-500"></textarea>
      </div>
      
      <!-- Buttons -->
      <div class="flex justify-end space-x-4">
        <button type="button" onclick="hideRatingModal()" 
                class="px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-800 transition-colors">
          Cancel
        </button>
        <button type="submit" 
                class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">
          Submit Rating
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Fallback-URL für fehlende Bilder global setzen
const NO_POSTER_URL = "{{ url_for('static', filename='images/no-poster.jpg') }}";

document.addEventListener('DOMContentLoaded', function() {
  const fallbackImgs = document.querySelectorAll('.fallback-img');
  
  fallbackImgs.forEach(img => {
    img.addEventListener('error', function() {
      this.src = NO_POSTER_URL;
    });
  });
  
  // Überprüfe, ob Bilder bereits fehlerhaft geladen wurden
  fallbackImgs.forEach(img => {
    if (img.complete && img.naturalHeight === 0) {
      img.src = NO_POSTER_URL;
    }
  });
});

let selectedRating = 0;

function showRatingModal(movieId) {
  document.getElementById('movieId').value = movieId;
  document.getElementById('ratingModal').classList.remove('hidden');
  document.getElementById('ratingModal').classList.add('flex');
}

function hideRatingModal() {
  document.getElementById('ratingModal').classList.add('hidden');
  document.getElementById('ratingModal').classList.remove('flex');
  resetRatingForm();
}

function resetRatingForm() {
  document.getElementById('ratingForm').reset();
  selectedRating = 0;
  updateStars();
}

function updateStars() {
  document.querySelectorAll('.rating-star').forEach((star, index) => {
    star.classList.toggle('text-yellow-400', index < selectedRating);
  });
}

document.querySelectorAll('.rating-star').forEach((star, index) => {
  star.addEventListener('click', () => {
    selectedRating = parseInt(star.dataset.rating);
    updateStars();
  });
});

document.getElementById('ratingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  formData.append('rating', selectedRating);
  
  try {
    const response = await fetch('/rate_movie', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      hideRatingModal();
      location.reload();
    } else {
      throw new Error('Failed to submit rating');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Failed to submit rating. Please try again.');
  }
});

function toggleWatchlist(movieId) {
  fetch(`/toggle_watchlist/${movieId}`, { method: 'POST' })
    .then(response => {
      if (response.ok) {
        // Update UI
      }
    })
    .catch(error => console.error('Error:', error));
}

function toggleWatched(movieId) {
  fetch(`/toggle_watched/${movieId}`, { method: 'POST' })
    .then(response => {
      if (response.ok) {
        // Update UI
      }
    })
    .catch(error => console.error('Error:', error));
}

document.addEventListener('DOMContentLoaded', function() {
    const categoryFilter = document.getElementById('category-filter');
    const platformFilter = document.getElementById('platform-filter');
    
    function applyFilters() {
        const categoryId = categoryFilter.value;
        const platformId = platformFilter.value;
        
        // Hier können wir später die Filter-Logik implementieren
        console.log('Category:', categoryId);
        console.log('Platform:', platformId);
    }
    
    if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
    if (platformFilter) platformFilter.addEventListener('change', applyFilters);

    // Scrollspy-Funktion
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const sections = document.querySelectorAll('.snap-section');
    
    function setActiveLink() {
        let found = false;
        const scrollPosition = window.scrollY + 100;
        
        sections.forEach((section, index) => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.offsetHeight;
            
            if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
                const id = section.getAttribute('id');
                
                sidebarLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#${id}`) {
                        link.classList.add('active');
                        found = true;
                    }
                });
            }
        });
        
        if (!found && sidebarLinks.length > 0) {
            sidebarLinks[0].classList.add('active');
        }
    }
    
    window.addEventListener('scroll', setActiveLink);
    window.addEventListener('load', setActiveLink);
});
</script>
{% endblock %}