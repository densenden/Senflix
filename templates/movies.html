{% extends "base.html" %}
{% from "components/movie_card.html" import movie_card %}
{% from 'components/navigation.html' import top_nav, side_nav %}

{% block title %}Movies - SenFlix{% endblock %}

{% block content %}
{% set anchors = [
    {'id': 'new-releases', 'label': 'New Releases'},
    {'id': 'popular', 'label': 'Popular'},
    {'id': 'friends-favorites', 'label': "Friends' Favorites"},
    {'id': 'top-rated', 'label': 'Top Rated by Community'},
    {'id': 'recent-comments', 'label': 'Recent Comments'}
] %}
{{ top_nav(current_user=current_user) }}
<div class="flex flex-row bg-black min-h-screen pt-16 snap-container">
  {{ side_nav(anchors=anchors, categories=categories) }}
  <main id="main-content" class="flex-1 bg-black text-gray-100 transition-all duration-500 snap-section">
    <div class="space-y-12 px-4 md:px-10">
      <!-- Hero Section -->
      <section class="relative h-[48vh] min-h-[320px] flex items-end snap-section" id="hero">
        <div class="absolute inset-0">
          <img src="{{ url_for('static', filename='images/hero.jpg') }}" alt="Hero background" class="w-full h-full object-cover opacity-40">
          <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent"></div>
        </div>
        <div class="relative z-10 p-8">
          <h1 class="text-4xl md:text-5xl font-bold mb-2">Welcome back, {{ current_user.name }}!</h1>
          <p class="text-lg text-gray-300">Discover new movies and keep track of your favorites.</p>
        </div>
      </section>
      <!-- New Releases Section -->
      <section id="new-releases" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">New Releases</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in new_releases %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>
      <!-- Popular Section -->
      <section id="popular" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Popular</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in popular_movies %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>
      <!-- Friends' Favorites Section -->
      <section id="friends-favorites" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Friends' Favorites</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in friends_favorites %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>
      <!-- Top Rated by Community Section -->
      <section id="top-rated" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Top Rated by Community</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in top_rated %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>
      <!-- Recent Comments Section -->
      <section id="recent-comments" class="snap-section">
        <h2 class="text-2xl font-bold mb-4 text-gray-100">Recent Comments</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
          {% for movie in recent_commented %}
            {{ movie_card(movie) }}
          {% else %}
            <p>No movies found.</p>
          {% endfor %}
        </div>
      </section>
      {% for category in categories %}
      <section id="category-{{ category.id }}" class="relative rounded-xl overflow-hidden shadow-lg mb-12 snap-section snap-always min-h-screen flex flex-col justify-end" style="height:100vh;">
        {% if category.img %}
        <div class="absolute inset-0 z-0">
          <img src="{{ url_for('static', filename='categories/' ~ category.img) }}" alt="{{ category.name }} background" class="w-full h-full object-cover object-center opacity-70">
          <div class="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-transparent"></div>
        </div>
        {% endif %}
        <div class="relative z-10 p-12 flex flex-col justify-end h-full">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-5xl font-extrabold text-white drop-shadow-lg">{{ category.name }}</h2>
            <a href="{{ url_for('category_detail', category_id=category.id) }}" class="ml-6 px-6 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold text-lg shadow-lg transition-all">More</a>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8">
            {% for movie in category.movies[:5] %}
              {{ movie_card(movie) }}
            {% else %}
              <p>No movies found.</p>
            {% endfor %}
          </div>
        </div>
      </section>
      {% endfor %}
      <!-- Category Grid Section -->
      <section class="category-grid snap-section">
        <h2>Nach Kategorie st√∂bern</h2>
        <div class="categories">
          {% for category in categories %}
            <a href="/movies?category={{ category.id }}" class="category-link">
              {% set category_obj = category %}
              {% include 'components/category_badge.html' %}
            </a>
          {% endfor %}
        </div>
      </section>
    </div>
  </main>
</div>
<style>
  body { background: #000; }
  .sidebar-link { color: #e5e7eb; text-decoration: none; transition: color 0.2s; }
  .sidebar-link:hover { color: #ef4444; }
  .sidebar-hidden {
    margin-left: 0 !important;
    max-width: 100vw !important;
  }
  #sidebar {
    position: fixed;
    top: 4rem;
    left: 0;
    height: calc(100vh - 4rem);
    z-index: 40;
  }
  .snap-container { scroll-snap-type: y mandatory; }
  .snap-section { scroll-snap-align: start; }
</style>

<!-- Rating Modal -->
<div id="ratingModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center">
  <div class="bg-gray-900 p-6 rounded-lg max-w-md w-full mx-4">
    <h2 class="text-2xl font-bold mb-6">Rate Movie</h2>
    
    <form id="ratingForm" class="space-y-6">
      <input type="hidden" id="movieId" name="movie_id">
      
      <!-- Star Rating -->
      <div>
        <label class="block text-sm font-medium mb-2">Your Rating</label>
        <div class="flex items-center space-x-1">
          {% for i in range(1, 11) %}
          <button type="button" 
                  class="rating-star w-8 h-8 text-gray-400 hover:text-yellow-400"
                  data-rating="{{ i }}">
            <svg fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
          </button>
          {% endfor %}
        </div>
      </div>
      
      <!-- Comment -->
      <div>
        <label for="comment" class="block text-sm font-medium mb-2">Your Comment (Optional)</label>
        <textarea id="comment" name="comment" rows="3"
                  class="w-full px-3 py-2 rounded-lg bg-gray-800 border border-gray-700 focus:border-red-500 focus:ring-1 focus:ring-red-500"></textarea>
      </div>
      
      <!-- Buttons -->
      <div class="flex justify-end space-x-4">
        <button type="button" onclick="hideRatingModal()" 
                class="px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-800 transition-colors">
          Cancel
        </button>
        <button type="submit" 
                class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">
          Submit Rating
        </button>
      </div>
    </form>
  </div>
</div>

<script>
let selectedRating = 0;

function showRatingModal(movieId) {
  document.getElementById('movieId').value = movieId;
  document.getElementById('ratingModal').classList.remove('hidden');
  document.getElementById('ratingModal').classList.add('flex');
}

function hideRatingModal() {
  document.getElementById('ratingModal').classList.add('hidden');
  document.getElementById('ratingModal').classList.remove('flex');
  resetRatingForm();
}

function resetRatingForm() {
  document.getElementById('ratingForm').reset();
  selectedRating = 0;
  updateStars();
}

function updateStars() {
  document.querySelectorAll('.rating-star').forEach((star, index) => {
    star.classList.toggle('text-yellow-400', index < selectedRating);
  });
}

document.querySelectorAll('.rating-star').forEach((star, index) => {
  star.addEventListener('click', () => {
    selectedRating = parseInt(star.dataset.rating);
    updateStars();
  });
});

document.getElementById('ratingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  formData.append('rating', selectedRating);
  
  try {
    const response = await fetch('/rate_movie', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      hideRatingModal();
      location.reload();
    } else {
      throw new Error('Failed to submit rating');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Failed to submit rating. Please try again.');
  }
});

function toggleWatchlist(movieId) {
  fetch(`/toggle_watchlist/${movieId}`, { method: 'POST' })
    .then(response => {
      if (response.ok) {
        // Update UI
      }
    })
    .catch(error => console.error('Error:', error));
}

function toggleWatched(movieId) {
  fetch(`/toggle_watched/${movieId}`, { method: 'POST' })
    .then(response => {
      if (response.ok) {
        // Update UI
      }
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}