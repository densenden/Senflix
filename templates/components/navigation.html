{% macro top_nav(current_user=None) %}
<nav class="fixed top-0 left-0 right-0 bg-black/80 backdrop-blur-sm z-50 border-b border-gray-800">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between h-16">
            <a href="{{ url_for('movies') }}" class="flex items-center">
                <img src="{{ url_for('static', filename='logos/senflix.svg') }}" alt="SenFlix Logo" class="h-10 w-auto">
            </a>
            <div class="flex items-center space-x-4">
                {% if current_user and current_user.is_authenticated %}
                    <a href="{{ url_for('user_profile', user_id=current_user.id) }}" class="flex items-center space-x-2 group">
                        {% set avatar_path = current_user.avatar.profile_image_url if current_user.avatar and current_user.avatar.profile_image_url else 'avatars/profile/avatar_' ~ current_user.avatar_id ~ '.jpg' %}
                        <img src="{{ url_for('static', filename=avatar_path) }}" alt="{{ current_user.name }}" class="w-8 h-8 rounded-full border-2 border-yellow-400 group-hover:border-white transition" onerror="this.src='/static/avatars/default.png';">
                        <span class="text-gray-200 group-hover:text-white font-semibold">{{ current_user.name }}</span>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>
{% endmacro %}

{% macro side_nav(anchors=None, categories=None) %}
<aside id="sidebar" class="fixed top-16 left-0 w-64 bg-black/80 backdrop-blur-sm overflow-y-auto transition-transform duration-500 h-[calc(100vh-4rem)] z-40" style="transform: translateX(0); user-select: none;">
    <div class="p-4">
        {% if anchors %}
        <h3 class="text-lg font-semibold mb-4">Sections</h3>
        <ul class="space-y-2 mb-8">
            {% for anchor in anchors %}
                <li>
                    <a href="#{{ anchor.id }}" class="sidebar-link text-gray-300 hover:text-white" data-section="{{ anchor.id }}">
                        {{ anchor.label }}
                    </a>
                </li>
            {% endfor %}
        </ul>
        {% endif %}
        {% if categories %}
        <h3 class="text-lg font-semibold mb-4">Categories</h3>
        <ul class="space-y-2">
            {% for category in categories %}
                <li>
                    <a href="#category-{{ category.id }}" class="sidebar-link text-gray-300 hover:text-white" data-section="category-{{ category.id }}">
                        {{ category.name }}
                    </a>
                </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div class="fade-dots absolute right-4 bottom-4 flex gap-1 z-50">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    </div>
</aside>
<script>
(function() {
  // DOM-Elemente
  const sidebar = document.getElementById('sidebar');
  const main = document.getElementById('main-content');
  let timer;
  
  // Animate dots: disappear one after another
  const dots = document.querySelectorAll('.fade-dots .dot');
  
  function resetDots() {
    dots.forEach(dot => dot.style.opacity = 1);
  }
  
  function animateDots() {
    resetDots();
    setTimeout(function() { 
      if (dots[0]) dots[0].style.opacity = 0; 
    }, 1000);
    setTimeout(function() { 
      if (dots[1]) dots[1].style.opacity = 0; 
    }, 2000);
    setTimeout(function() { 
      if (dots[2]) dots[2].style.opacity = 0; 
    }, 3000);
  }
  
  function showDots() {
    resetDots();
    const fadeDotsElem = document.querySelector('.fade-dots');
    if (fadeDotsElem) fadeDotsElem.style.display = '';
  }
  
  function hideDots() {
    const fadeDotsElem = document.querySelector('.fade-dots');
    if (fadeDotsElem) fadeDotsElem.style.display = 'none';
  }

  function slideOut() {
    if (sidebar) sidebar.style.transform = 'translateX(-100%)';
    if (main) main.style.marginLeft = '0';
    if (main) main.classList.add('sidebar-hidden');
    hideDots();
  }

  function slideIn() {
    if (sidebar) sidebar.style.transform = 'translateX(0)';
    if (main) main.style.marginLeft = '16rem';
    if (main) main.classList.remove('sidebar-hidden');
    showDots();
    animateDots();
  }

  function resetTimer() {
    slideIn();
    clearTimeout(timer);
    timer = setTimeout(slideOut, 5000);
  }

  // Scrollspy-Implementierung
  function highlightActiveSection() {
    const links = document.querySelectorAll('#sidebar .sidebar-link');
    const sections = Array.from(document.querySelectorAll('.snap-section'));
    
    // Aktuelle Scroll-Position mit Offset
    const scrollPosition = window.scrollY + 100;
    
    // Finde die aktuelle Sektion
    let activeSection = null;
    
    // Durchlaufe alle Sektionen, um die aktuelle zu finden
    for (let i = 0; i < sections.length; i++) {
      const section = sections[i];
      const sectionTop = section.offsetTop;
      const sectionHeight = section.offsetHeight;
      
      if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
        activeSection = section;
        break;
      }
    }
    
    // Falls keine aktive Sektion gefunden wurde, aber wir ganz unten auf der Seite sind
    if (!activeSection && scrollPosition >= document.body.scrollHeight - window.innerHeight) {
      activeSection = sections[sections.length - 1];
    }
    
    // Markiere den entsprechenden Link als aktiv
    links.forEach(link => {
      const href = link.getAttribute('href');
      link.classList.toggle('active', activeSection && href === '#' + activeSection.id);
    });
  }

  // Event-Listener
  window.addEventListener('scroll', highlightActiveSection);
  window.addEventListener('load', highlightActiveSection);
  window.addEventListener('resize', highlightActiveSection);

  ['mousemove', 'keydown', 'touchstart'].forEach(evt => {
    document.addEventListener(evt, function() {
      showDots();
      resetTimer();
    }, {passive: true});
  });
  
  // Initialisieren
  resetTimer();
  highlightActiveSection();
})();
</script>
{% endmacro %}