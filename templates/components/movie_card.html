{% macro movie_card(movie) %}
{# --- Variable Setup --- #}
{% set movie_id = movie.get('id', movie.get('movie_id')) %}
{% set movie_name = movie.get('name', movie.get('title', 'No title')) %}
{% set movie_year = movie.get('year', 'N/A') %}
{% set movie_img = movie.get('img', '') %}
{% set movie_rating = movie.get('rating') %}
{% set movie_categories = movie.get('categories', []) %}
{% set omdb_data = movie.get('omdb_data', {}) %}
{% set imdb_rating = omdb_data.get('imdb_rating') %}
{% set poster_img = omdb_data.get('poster_img', movie_img) %}
{% set is_watched = movie.get('user_watched', False) %}
{% set is_on_watchlist = movie.get('user_watchlist', False) %}
{% set is_rated = movie.get('user_rated', False) %}
{% set watched_by_avatars = movie.get('watched_by_avatars', []) %}

{# --- Card Structure --- #}
<div class="movie-card-wrapper group rounded-lg overflow-visible bg-gray-800" 
     data-movie-id="{{ movie_id }}">
    {# Link the whole card #}
    <a href="{{ url_for('movie_detail', movie_id=movie_id) }}" 
       class="block w-full h-full relative overflow-hidden rounded-lg">
        
        {# Poster Background #}
        <div class="poster-bg absolute inset-0 w-full h-full transition-transform duration-150 ease-out bg-cover bg-center rounded-lg"
             {% if poster_img %}style="background-image: url('{{ url_for('static', filename='movies/' ~ poster_img) }}');"{% endif %}>
            
            {# Placeholder text if no poster #}
            {% if not poster_img %}
            <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-700 to-gray-800 rounded-lg">
                <span class="text-center text-gray-300 text-xs px-2">{{ movie_name }}</span>
            </div>
            {% endif %}

            {# Hover Overlay #}
            <div class="overlay absolute inset-0 flex flex-col p-3 rounded-lg 
                        bg-gradient-to-t from-black/95 via-black/60 to-transparent 
                        opacity-0 group-hover:opacity-100 transition-opacity duration-300 ease-in-out">
                
                {# Top part - empty for now #}
                <div class="flex-grow"></div>

                {# Bottom part - info and actions #}
                <div>
                    {# Movie Title, Year, Rating #}
                    <div class="mb-2">
                        <h3 class="text-white font-bold text-base leading-tight mb-0.5 truncate" title="{{ movie_name }}">{{ movie_name }}</h3>
                        <div class="flex items-center text-xs text-gray-300">
                            <span>{{ movie_year }}</span>
                            {% if imdb_rating and imdb_rating != 'N/A' %}
                            <span class="mx-1.5">|</span>
                            <span class="flex items-center">
                                <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                {{ "%.1f"|format(imdb_rating|float) }}
                            </span>
                            {% elif movie_rating %}
                            <span class="mx-1.5">|</span>
                            <span class="flex items-center">
                                <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                {{ movie_rating|round(1) if movie_rating else 'N/A' }}
                            </span>
                            {% endif %}
                        </div>
                        
                        {# Categories if available #}
                        {% if movie_categories %}
                        <div class="flex flex-wrap gap-1 mt-1">
                            {% for category in movie_categories %}
                            <span class="text-xs bg-gray-800 px-1.5 py-0.5 rounded">{{ category.name }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    {# Footer with Avatars and Action Buttons in a fixed-height container #}
                    <div class="footer-container h-8 flex items-center justify-between pb-1 pt-1">
                        {# Avatars Container - Left #}
                        <div class="avatars-container h-full flex -space-x-2 overflow-visible">
                            {% for avatar_url in watched_by_avatars %}
                            <div class="avatar-wrapper w-6 h-6 rounded-full overflow-hidden flex-shrink-0 border border-gray-700">
                                <img src="{{ url_for('static', filename=avatar_url) }}" 
                                     alt="Watched by user" 
                                     class="w-full h-full object-cover">
                            </div>
                            {% endfor %}
                        </div>
                        
                        {# Action Buttons Container - Right #}
                        <div class="action-buttons flex space-x-1.5" onclick="event.stopPropagation(); event.preventDefault();">
                            {# Watchlist Button (Eye / Eye-Off) #}
                            <button 
                                class="action-btn watchlist-btn {{ 'active' if is_on_watchlist else '' }}" 
                                data-movie-id="{{ movie_id }}"
                                data-action="watchlist">
                                {# Eye Icon (Add to Watchlist) #}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-eye" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                {# Eye Off Icon (Remove from Watchlist) #}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-eye-off" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                </svg>
                                <span class="tooltip">{{ 'Remove from Watchlist' if is_on_watchlist else 'Add to Watchlist' }}</span>
                            </button>
                            
                            {# Watched Button (Eye / Eye-Slash) #}
                            <button 
                                class="action-btn watched-btn {{ 'active' if is_watched else '' }}" 
                                data-movie-id="{{ movie_id }}"
                                data-action="watched">
                                 {# Eye Icon (Marked as Watched) #}
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-eye" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                  </svg>
                                 {# Eye Slash Icon (Not Watched) #}
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-eye-slash" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                                 </svg>
                                <span class="tooltip">{{ 'Mark as Unwatched' if is_watched else 'Mark as Watched' }}</span>
                            </button>
                            
                            {# Rate Button (Star Outline / Star Filled) #}
                            <button 
                                class="action-btn rate-btn {{ 'active' if is_rated else '' }}" 
                                data-movie-id="{{ movie_id }}"
                                data-action="rate">
                                {# Star Outline Icon (Rate Movie) #}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-star-outline" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                   <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                                {# Star Filled Icon (Update Rating) #}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-star-filled" fill="currentColor" viewBox="0 0 20 20">
                                   <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                                <span class="tooltip">{{ 'Update Rating' if is_rated else 'Rate Movie' }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </a> 
</div>

{# --- Styles for Movie Card --- #}
<style>
/* Main Card Styles */
.movie-card-wrapper {
    position: relative;
    height: 350px !important;
    max-height: 350px !important;
    aspect-ratio: 2/3;
    transition: transform 0.3s;
    perspective: 1000px;
    overflow: visible; /* Allow tooltips to overflow */
}

.poster-bg {
    background-color: #1f2937; /* Fallback color */
    transform-style: preserve-3d;
    transition: transform 0.3s;
}

.movie-card-wrapper:hover .poster-bg {
    transform: scale(1.05);
}

/* Fixed Footer Container */
.footer-container {
    position: relative;
    width: 100%;
}

/* Avatar Container Styles */
.avatars-container {
    position: relative;
    flex-shrink: 0;
    z-index: 5;
    padding-left: 4px;
}

/* Action Button Styles */
.action-buttons {
    display: flex;
    gap: 0.375rem;
    position: relative;
    z-index: 10;
}

.action-btn {
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    background: rgba(17, 24, 39, 0.8);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(75, 85, 99, 0.4);
    color: #9CA3AF;
    transition: all 0.2s ease;
    position: relative;
    overflow: visible;
}

.action-btn:hover {
    background: rgba(31, 41, 55, 0.9);
    border-color: rgba(75, 85, 99, 0.6);
    color: #E5E7EB;
    transform: translateY(-1px);
}

.action-btn.active {
    background: rgba(220, 38, 38, 0.9);
    border-color: rgba(220, 38, 38, 0.6);
    color: white;
}

.action-btn.processing {
    pointer-events: none;
    opacity: 0.7;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 0.5; }
    100% { transform: scale(1); opacity: 0.7; }
}

/* Tooltip Styles - Enhanced */
.action-btn .tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    padding: 6px 10px;
    background: rgba(17, 24, 39, 0.95);
    color: #e5e7eb;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 6px;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
    z-index: 50;
    pointer-events: none;
}
.action-btn:hover .tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(-12px);
}
.action-btn .tooltip::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px;
    border-style: solid;
    border-color: rgba(17, 24, 39, 0.95) transparent transparent transparent;
}

/* Default Icon Visibility - Relies on .active class */
.action-btn:not(.active) .icon-eye-off,
.action-btn:not(.active) .icon-eye, /* Changed from icon-tv */
.action-btn:not(.active) .icon-star-filled {
    display: none;
}
.action-btn:not(.active) .icon-eye,
.action-btn:not(.active) .icon-eye-slash, /* Changed from icon-tv-off */
.action-btn:not(.active) .icon-star-outline {
    display: block;
}

/* Active Icon Visibility */
.action-btn.active .icon-eye,
.action-btn.active .icon-eye-slash, /* Changed from icon-tv-off */
.action-btn.active .icon-star-outline {
    display: none;
}
.action-btn.active .icon-eye-off,
.action-btn.active .icon-eye, /* Changed from icon-tv */
.action-btn.active .icon-star-filled {
    display: block;
}

/* Avatar Styles */
.avatar-wrapper {
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 1;
}

/* Style each avatar with a smooth animation */
.avatars-container .avatar-wrapper:nth-child(1) { z-index: 5; }
.avatars-container .avatar-wrapper:nth-child(2) { z-index: 4; }
.avatars-container .avatar-wrapper:nth-child(3) { z-index: 3; }
.avatars-container .avatar-wrapper:nth-child(4) { z-index: 2; }
.avatars-container .avatar-wrapper:nth-child(5) { z-index: 1; }

.avatar-wrapper:hover {
    transform: translateY(-3px) scale(1.15);
    z-index: 10;
}
</style>

{% endmacro %}