{% macro movie_card(movie) %}
{% set movie_id = movie.get('id', movie.get('movie_id')) %}
{% set movie_name = movie.get('name', 'No title') %}
{% set movie_year = movie.get('year', 'N/A') %}
{% set imdb_rating = movie.get('omdb_data', {}).get('imdb_rating') %}
{# Pass watched/watchlist status if available, default to false #}
{% set is_watched = movie.get('watched', False) %}
{% set is_on_watchlist = movie.get('watchlist', False) %}

{# Direkter Zugriff auf die Bild-URL über die neue Route #}
{% set omdb_data = movie.get('omdb_data', {}) %}
{% set poster_img = omdb_data.get('poster_img') %}
{% set poster_src = url_for('static', filename='movies/' ~ poster_img) if poster_img else None %}

<div class="movie-card-3d-wrapper group aspect-[2/3] rounded-lg overflow-hidden" 
     style="perspective: 1000px;">
    <a href="{{ url_for('movie_detail', movie_id=movie_id) }}" class="block w-full h-full">
        <div class="movie-card-3d relative w-full h-full shadow-lg transition-transform duration-150 ease-out bg-gray-900 rounded-lg"
             style="transform-style: preserve-3d;" 
             data-movie-name="{{ movie_name }}" 
             data-poster-img="{{ poster_img }}" 
             data-poster-src="{{ poster_src }}">
            
            {# Poster Image (Background) #}
            {% if poster_src %}
            <img src="{{ poster_src }}" 
                 alt="{{ movie_name }}"
                 class="absolute inset-0 w-full h-full object-cover rounded-lg transition-opacity duration-300">
            {% else %}
            <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center rounded-lg">
                <span class="text-gray-300 text-xs">{{ movie_name[:10] }}{% if movie_name|length > 10 %}...{% endif %}</span>
            </div>
            {% endif %}

            {# Debug-Info - Wird angezeigt, wenn ?debug=1 in der URL ist #}
            <div class="absolute top-0 left-0 bg-black/80 text-white text-xs p-1 z-50 movie-debug-info">
                <strong>Movie ID:</strong> {{ movie_id }}<br>
                <strong>Poster:</strong> {{ poster_img }}<br>
                <strong>URL:</strong> {{ poster_src }}
            </div>

            {# Hover Overlay Content #}
            <div class="absolute inset-0 flex flex-col justify-end p-4 rounded-lg
                        bg-gradient-to-t from-black/95 via-black/70 to-transparent 
                        opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out"
                 style="transform: translateZ(50px);"> {# Slightly raise overlay content #}
                
                {# Movie Info #}
                <div class="mb-auto pt-4"> {# Push icons down #}
                    <h3 class="text-white font-bold text-lg leading-tight mb-1">{{ movie_name }}</h3>
                    <div class="flex items-center text-xs text-gray-400">
                        <span>{{ movie_year }}</span>
                        {% if imdb_rating %}
                        <span class="mx-2">|</span>
                        <span class="flex items-center">
                            <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            {{ "%.1f"|format(imdb_rating) }}
                        </span>
                        {% endif %}
                    </div>
                </div>

                {# Action Icons #}
                <div class="flex items-center justify-between space-x-2 mt-3" onclick="event.preventDefault(); event.stopPropagation();">
                    {# Add dynamic class based on is_on_watchlist #}
                    <button 
                        class="action-icon watchlist-btn {{ 'action-icon-active' if is_on_watchlist else '' }}" 
                        title="{{ 'Remove from Watchlist' if is_on_watchlist else 'Add to Watchlist' }}" 
                        data-movie-id="{{ movie_id }}"
                        onclick="toggleWatchlist(this, {{ movie_id }}); return false;">
                        {# Plus icon for add, checkmark for remove? Or just toggle style #}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-add" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 icon-remove hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </button>
                    {# Add dynamic class based on is_watched #}
                    <button 
                        class="action-icon watched-btn {{ 'action-icon-active' if is_watched else '' }}" 
                        title="{{ 'Mark as Unwatched' if is_watched else 'Mark as Watched' }}" 
                        data-movie-id="{{ movie_id }}"
                        onclick="toggleWatched(this, {{ movie_id }}); return false;">
                        {# TV icon #}
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="6" width="18" height="12" rx="2" ry="2" />
                            <path d="M5 12h14M12 6v12" />
                        </svg>
                    </button>
                    <button 
                        class="action-icon rate-btn" 
                        title="Rate Movie" 
                        data-movie-id="{{ movie_id }}"
                        onclick="showRatingModal({{ movie_id }}); return false;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </a> {# End link wrapper #}
</div>

{# Add CSS and JS directly within the macro scope #}
<style>
.movie-card-3d-wrapper .action-icon {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 9999px;
    padding: 0.35rem;
    color: rgba(255, 255, 255, 0.8);
    transition: background-color 0.2s, color 0.2s;
    line-height: 0; /* Prevent extra space */
}
.movie-card-3d-wrapper .action-icon:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
}
/* Style for active state */
.movie-card-3d-wrapper .action-icon-active {
    background-color: rgba(239, 68, 68, 0.8); /* Example: Red background */
    color: white;
}
.movie-card-3d-wrapper .action-icon-active:hover {
    background-color: rgba(239, 68, 68, 1); 
}
/* Toggle visibility of add/remove icons for watchlist */
.movie-card-3d-wrapper .watchlist-btn .icon-remove {
    display: none;
}
.movie-card-3d-wrapper .watchlist-btn.action-icon-active .icon-add {
    display: none;
}
.movie-card-3d-wrapper .watchlist-btn.action-icon-active .icon-remove {
    display: inline-block;
}

/* Prevent image dragging ghost */
.movie-card-3d img {
    pointer-events: none; 
    user-select: none;
}
</style>

<script>
(function() {
    // Debug-Modus aktivieren, wenn ?debug=1 in der URL
    const params = new URLSearchParams(window.location.search);
    const debugMode = params.get('debug') === '1';
    if (debugMode) {
        document.querySelectorAll('.movie-debug-info').forEach(el => {
            el.style.display = 'block';
        });
    }
    
    // Ensure this runs only once per card instance if macro is used multiple times
    const cardWrappers = document.querySelectorAll('.movie-card-3d-wrapper');
    
    cardWrappers.forEach(wrapper => {
        // Check if listeners are already attached
        if (wrapper.dataset.listenersAttached === 'true') {
            return; 
        }
        wrapper.dataset.listenersAttached = 'true';

        const card = wrapper.querySelector('.movie-card-3d');
        if (!card) return;

        const intensity = 15; // How much tilt

        wrapper.addEventListener('mousemove', (e) => {
            const rect = wrapper.getBoundingClientRect();
            const x = e.clientX - rect.left; // Mouse X position relative to element.
            const y = e.clientY - rect.top;  // Mouse Y position relative to element.

            const halfWidth = rect.width / 2;
            const halfHeight = rect.height / 2;

            const rotateY = ((x - halfWidth) / halfWidth) * intensity;
            const rotateX = ((y - halfHeight) / halfHeight) * -intensity; // Invert X rotation

            card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        });

        wrapper.addEventListener('mouseleave', () => {
            card.style.transform = 'rotateX(0deg) rotateY(0deg)'; // Reset transform
        });

        // Spezielles Debug-Logging für das Bild
        const img = card.querySelector('img');
        const movieName = card.dataset.movieName;
        const posterImg = card.dataset.posterImg;
        console.log(`Film "${movieName}" hat Poster: ${posterImg}`);
    });
    
    // Define toggle functions if they don't exist globally
    if (typeof window.toggleWatchlist !== 'function') {
        window.toggleWatchlist = function(buttonElement, movieId) { 
            console.log('Toggle watchlist for:', movieId);
            // Optimistic UI update
            const isActive = buttonElement.classList.toggle('action-icon-active');
            buttonElement.title = isActive ? 'Remove from Watchlist' : 'Add to Watchlist';
            // Actual fetch call
            fetch(`/toggle_watchlist/${movieId}`, { method: 'POST' })
                .then(response => {
                    if (!response.ok) {
                        // Revert UI on error
                        buttonElement.classList.toggle('action-icon-active'); 
                         buttonElement.title = !isActive ? 'Remove from Watchlist' : 'Add to Watchlist';
                        console.error('Failed to toggle watchlist');
                    }
                    // Optionally handle success, maybe refresh part of the page if needed
                })
                .catch(error => {
                    // Revert UI on error
                     buttonElement.classList.toggle('action-icon-active'); 
                     buttonElement.title = !isActive ? 'Remove from Watchlist' : 'Add to Watchlist';
                    console.error('Error toggling watchlist:', error);
                });
         }
    }
    if (typeof window.toggleWatched !== 'function') {
       window.toggleWatched = function(buttonElement, movieId) { 
           console.log('Toggle watched for:', movieId);
            // Optimistic UI update
           const isActive = buttonElement.classList.toggle('action-icon-active');
           buttonElement.title = isActive ? 'Mark as Unwatched' : 'Mark as Watched';
            // Actual fetch call
           fetch(`/toggle_watched/${movieId}`, { method: 'POST' })
                .then(response => {
                    if (!response.ok) {
                        // Revert UI on error
                        buttonElement.classList.toggle('action-icon-active');
                        buttonElement.title = !isActive ? 'Mark as Unwatched' : 'Mark as Watched';
                        console.error('Failed to toggle watched');
                    }
                })
                .catch(error => {
                    // Revert UI on error
                    buttonElement.classList.toggle('action-icon-active');
                    buttonElement.title = !isActive ? 'Mark as Unwatched' : 'Mark as Watched';
                    console.error('Error toggling watched:', error);
                });
        }
    }
     // showRatingModal should exist from movies.html script
    
})();
</script>
{% endmacro %}