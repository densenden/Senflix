{% macro movie_card(movie) %}
{% set movie_id = movie.get('id', movie.get('movie_id')) %}
{% set fallback_img_src = url_for('static', filename='movies/no-poster.jpg') %}
{% set poster_src = fallback_img_src %} {# Default to fallback #}
{% if movie and movie.get('omdb_data') and movie['omdb_data'].get('poster_img') %}
    {# Check if the specific poster file exists? Could be slow. Trusting the data for now. #}
    {% set poster_src = url_for('static', filename='movies/' + movie['omdb_data']['poster_img']) %}
{% endif %}

<div class="movie-card-3d-wrapper group aspect-[2/3] rounded-lg overflow-hidden" 
     style="perspective: 1000px;">
    <div class="movie-card-3d relative w-full h-full shadow-lg transition-transform duration-150 ease-out bg-gray-900 rounded-lg"
         style="transform-style: preserve-3d;">
        
        {# Poster Image (Background) #}
        <img src="{{ poster_src }}" 
             alt="{{ movie.get('name', 'Movie Poster') }}"
             class="absolute inset-0 w-full h-full object-cover rounded-lg transition-opacity duration-300"
             onerror="this.onerror=null; this.src='{{ fallback_img_src }}';">

        {# Hover Overlay Content #}
        <div class="absolute inset-0 flex flex-col justify-end p-4 rounded-lg
                    bg-gradient-to-t from-black/95 via-black/70 to-transparent 
                    opacity-0 group-hover:opacity-100 transition-all duration-300 ease-in-out"
             style="transform: translateZ(50px);"> {# Slightly raise overlay content #}
            
            {# Movie Info #}
            <div class="mb-3">
                <h3 class="text-white font-bold text-lg leading-tight mb-1">{{ movie.get('name', 'No title') }}</h3>
                <div class="flex items-center text-xs text-gray-400">
                    <span>{{ movie.get('year', 'N/A') }}</span>
                    {% if movie and movie.get('omdb_data') and movie['omdb_data'].get('imdb_rating') %}
                    <span class="mx-2">|</span>
                    <span class="flex items-center">
                        <svg class="w-3 h-3 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        {{ "%.1f"|format(movie['omdb_data']['imdb_rating']) }}
                    </span>
                    {% endif %}
                </div>
            </div>

            {# Watched Avatars Placeholder #}
            {# <div class="flex -space-x-2 mb-3">
                <img class="inline-block h-6 w-6 rounded-full ring-2 ring-black" src="{{ url_for('static', filename='avatars/default.png') }}" alt="User 1">
                <img class="inline-block h-6 w-6 rounded-full ring-2 ring-black" src="{{ url_for('static', filename='avatars/default.png') }}" alt="User 2">
            </div> #}

            {# Action Icons #}
            <div class="flex items-center justify-between space-x-2">
                 {# Placeholder buttons - Add JS functionality later #}
                 <button class="action-icon watchlist-btn" title="Toggle Watchlist" onclick="event.stopPropagation(); toggleWatchlist('{{ movie_id }}')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                </button>
                <button class="action-icon watched-btn" title="Toggle Watched" onclick="event.stopPropagation(); toggleWatched('{{ movie_id }}')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-.474 1.486-1.286 2.838-2.285 3.949M2.458 12l2.285 3.949m0 0A11.953 11.953 0 0112 19c4.478 0 8.268-2.943 9.542-7" /></svg>
                 </button>
                <button class="action-icon rate-btn" title="Rate Movie" onclick="event.stopPropagation(); showRatingModal('{{ movie_id }}');">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                </button>
            </div>
        </div>
    </div>
</div>

{# Add CSS and JS directly within the macro scope #}
<style>
.movie-card-3d-wrapper .action-icon {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 9999px;
    padding: 0.35rem;
    color: rgba(255, 255, 255, 0.8);
    transition: background-color 0.2s, color 0.2s;
    line-height: 0; /* Prevent extra space */
}
.movie-card-3d-wrapper .action-icon:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
}
/* Prevent image dragging ghost */
.movie-card-3d img {
    pointer-events: none; 
    user-select: none;
}
</style>

<script>
(function() {
    // Ensure this runs only once per card instance if macro is used multiple times
    const cardWrappers = document.querySelectorAll('.movie-card-3d-wrapper');
    
    cardWrappers.forEach(wrapper => {
        // Check if listeners are already attached
        if (wrapper.dataset.listenersAttached === 'true') {
            return; 
        }
        wrapper.dataset.listenersAttached = 'true';

        const card = wrapper.querySelector('.movie-card-3d');
        if (!card) return;

        const intensity = 15; // How much tilt

        wrapper.addEventListener('mousemove', (e) => {
            const rect = wrapper.getBoundingClientRect();
            const x = e.clientX - rect.left; // Mouse X position relative to element.
            const y = e.clientY - rect.top;  // Mouse Y position relative to element.

            const halfWidth = rect.width / 2;
            const halfHeight = rect.height / 2;

            const rotateY = ((x - halfWidth) / halfWidth) * intensity;
            const rotateX = ((y - halfHeight) / halfHeight) * -intensity; // Invert X rotation

            card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        });

        wrapper.addEventListener('mouseleave', () => {
            card.style.transform = 'rotateX(0deg) rotateY(0deg)'; // Reset transform
        });
    });
    
    // Define dummy functions if they don't exist globally
    if (typeof toggleWatchlist !== 'function') {
        window.toggleWatchlist = function(movieId) { console.log('Toggle watchlist for:', movieId); /* Implement fetch later */ }
    }
    if (typeof toggleWatched !== 'function') {
       window.toggleWatched = function(movieId) { console.log('Toggle watched for:', movieId); /* Implement fetch later */ }
    }
     // showRatingModal should exist from movies.html script
    
})();
</script>
{% endmacro %}